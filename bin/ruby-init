#!/usr/bin/env bash
set -euo pipefail

# ruby-init
# Initialize Ruby development environment with rbenv.
# This script is called by the Ruby nix-shell to set up the correct Ruby version,
# install bundler, and run bundle install if needed.
#
# Environment variables:
#   RUBY_BUILD_SKIP_UPDATE - Skip ruby-build update (default: 0)
#   SKIP_BUNDLE_INSTALL    - Skip bundle install (default: 0)
#
# Side effects:
#   - Installs/updates ruby-build plugin
#   - Installs Ruby version if not present
#   - Creates .ruby-version in current directory
#   - Installs bundler if not present
#   - Runs bundle install if Gemfile changed

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
RBENV_ROOT="${RBENV_ROOT:-$HOME/.rbenv}"

# Install ruby-build plugin if not present
if [ ! -d "$RBENV_ROOT"/plugins/ruby-build ]; then
  echo -e "${BLUE}→ Installing ruby-build plugin...${NC}"
  mkdir -p "$RBENV_ROOT"/plugins
  git clone --quiet https://github.com/rbenv/ruby-build.git "$RBENV_ROOT"/plugins/ruby-build
fi

# Update ruby-build once per day (unless RUBY_BUILD_SKIP_UPDATE=1)
if [ "${RUBY_BUILD_SKIP_UPDATE:-0}" != "1" ]; then
  RUBY_BUILD_UPDATED="$RBENV_ROOT/plugins/ruby-build/.last_update"
  if [ ! -f "$RUBY_BUILD_UPDATED" ] || [ $(find "$RUBY_BUILD_UPDATED" -mtime +1 2>/dev/null | wc -l) -gt 0 ]; then
    echo -e "${BLUE}→ Updating ruby-build definitions...${NC}"
    if git -C "$RBENV_ROOT"/plugins/ruby-build pull --quiet 2>/dev/null; then
      touch "$RUBY_BUILD_UPDATED"
    else
      echo -e "${YELLOW}⚠ Could not update ruby-build (network issue?)${NC}" >&2
    fi
  fi
fi

# Determine which Ruby version to use
if [ -f .ruby-version ]; then
  RUBY_VERSION="$(cat .ruby-version)"
else
  # Find the latest stable Ruby version from ruby-build
  RUBY_VERSION=$(ls "$RBENV_ROOT"/plugins/ruby-build/share/ruby-build/ | \
    grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | \
    sort -V | \
    tail -1)
fi

echo -e "${CYAN}→ Using Ruby ${RUBY_VERSION}${NC}"

# Install Ruby if not already installed
if ! rbenv versions --bare | grep -Fx "$RUBY_VERSION" >/dev/null 2>&1; then
  echo -e "${BLUE}→ Installing Ruby ${RUBY_VERSION} (this may take a while)...${NC}"
  rbenv install "$RUBY_VERSION"
  echo -e "${GREEN}✓ Ruby ${RUBY_VERSION} installed${NC}"
fi
rbenv local "$RUBY_VERSION"

# Add Ruby's lib directory to library path (needed for shared library)
export LD_LIBRARY_PATH="$RBENV_ROOT/versions/$RUBY_VERSION/lib:${LD_LIBRARY_PATH:-}"

# Install bundler if not present
if ! rbenv exec gem list -i "^bundler$" > /dev/null 2>&1; then
  echo -e "${BLUE}→ Installing bundler...${NC}"
  rbenv exec gem install bundler --quiet
fi

# Run bundle install only if Gemfile changed (unless SKIP_BUNDLE_INSTALL=1)
if [ "${SKIP_BUNDLE_INSTALL:-0}" != "1" ] && [ -f Gemfile ]; then
  if [ ! -f Gemfile.lock ] || [ Gemfile -nt Gemfile.lock ]; then
    echo -e "${BLUE}→ Running bundle install...${NC}"
    rbenv exec bundle install
  fi
fi

echo -e "${GREEN}✓ Ruby environment ready${NC}"
echo ""
