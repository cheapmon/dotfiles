#!/usr/bin/env bash
set -euo pipefail

# decrypt-secrets
# Decrypt age-encrypted secrets to runtime directory.
# This script runs as a systemd service on system startup.
#
# Decrypts secrets from ~/.vault/*.age into /run/user/$(id -u)/secrets
# Also decrypts SSH keys to ~/.ssh/ and imports GPG keys into keyring.
#
# Secrets decrypted:
#   - API tokens (api_token, digitalocean_token, terraform_token, anthropic_api_key)
#   - SSH keys (id_rsa, id_rsa.pub, id_ed25519, id_ed25519.pub)
#   - GPG keys (inaudito-hi-pub/priv, inaudito-lo-pub/priv)
#
# Prerequisites:
#   - Age key must exist at ~/.config/age/key.txt with 600 permissions
#   - Encrypted files must exist in ~/.vault/
#
# To encrypt a new file:
#   age -e -i ~/.config/age/key.txt <plaintext> > ~/.vault/<filename>.age
#
# Dependencies: age, gpg2, check-vault-key
# Side effects:
#   - Creates files in /run/user/$(id -u)/secrets (cleared on logout)
#   - Backs up and overwrites ~/.ssh/id_rsa, ~/.ssh/id_rsa.pub, ~/.ssh/id_ed25519, ~/.ssh/id_ed25519.pub
#   - Imports GPG keys into user's keyring
#   - Changes git remote URL for dotfiles repo to use SSH
#
# Logs to: ~/.cache/decrypt-secrets.log
#

umask 077

# Configuration
VAULT="$HOME/.vault"
KEY="${XDG_CONFIG_HOME:-$HOME/.config}/age/key.txt"
SECRETS="/run/user/$(id -u)/secrets"
SSH_DIR="$HOME/.ssh"
LOG_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/decrypt-secrets.log"
BACKUP_DIR="$SSH_DIR/backups"

# Counters for summary
SUCCESS_COUNT=0
FAILURE_COUNT=0

# Logging function
log() {
    local timestamp
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] $*" | tee -a "$LOG_FILE"
}

log_error() {
    log "ERROR: $*"
    ((FAILURE_COUNT++)) || true
}

log_success() {
    log "SUCCESS: $*"
    ((SUCCESS_COUNT++)) || true
}

# Initialize log file
mkdir -p "$(dirname "$LOG_FILE")"
log "→ Starting secret decryption"

# Check vault key
if [ -x "$HOME/bin/check-vault-key" ]; then
    if ! "$HOME/bin/check-vault-key" >> "$LOG_FILE" 2>&1; then
        log_error "Vault key check failed"
        exit 1
    fi
    log "Vault key check passed"
else
    log_error "check-vault-key helper missing at $HOME/bin/check-vault-key"
    exit 1
fi

# Clean up any old decrypted files from .vault (migration from old approach)
if [ -d "$VAULT" ]; then
    if find "$VAULT" -type f ! -name "*.age" -delete 2>/dev/null; then
        log "Cleaned up old decrypted files from vault"
    fi
fi

# Create secure runtime directory for decrypted secrets
if ! mkdir -p "$SECRETS"; then
    log_error "Failed to create secrets directory: $SECRETS"
    exit 1
fi

if ! chmod 700 "$SECRETS"; then
    log_error "Failed to set permissions on secrets directory"
    exit 1
fi

log "Created secrets directory: $SECRETS"

# Function to decrypt a file
decrypt_file() {
    local src="$1"
    local dst="$2"
    local name="${src##*/}"
    name="${name%.age}"

    if [ ! -f "$src" ]; then
        log_error "Source file not found: $src"
        return 1
    fi

    if ! age -d -i "$KEY" "$src" > "$dst" 2>> "$LOG_FILE"; then
        log_error "Failed to decrypt $name"
        rm -f "$dst"
        return 1
    fi

    # Validate decrypted file is not empty
    if [ ! -s "$dst" ]; then
        log_error "Decrypted file is empty: $name"
        rm -f "$dst"
        return 1
    fi

    log_success "Decrypted $name"
    return 0
}

# Decrypt API tokens to runtime directory
log "→ Decrypting API tokens"
decrypt_file "$VAULT/api_token.age" "$SECRETS/api_token"
decrypt_file "$VAULT/digitalocean_token.age" "$SECRETS/digitalocean_token"
decrypt_file "$VAULT/terraform_token.age" "$SECRETS/terraform_token"
decrypt_file "$VAULT/anthropic_api_key.age" "$SECRETS/anthropic_api_key"

# Setup SSH directory
if [ ! -d "$SSH_DIR" ]; then
    if ! mkdir -p "$SSH_DIR"; then
        log_error "Failed to create SSH directory"
        exit 1
    fi
fi

if ! chmod 700 "$SSH_DIR"; then
    log_error "Failed to set permissions on SSH directory"
    exit 1
fi

# Create backup directory for SSH keys
if [ ! -d "$BACKUP_DIR" ]; then
    if ! mkdir -p "$BACKUP_DIR"; then
        log_error "Failed to create backup directory"
    else
        chmod 700 "$BACKUP_DIR"
        log "Created SSH backup directory"
    fi
fi

# Backup existing SSH keys before overwriting
log "→ Backing up existing SSH keys"
TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
for key_file in id_rsa id_rsa.pub id_ed25519 id_ed25519.pub; do
    if [ -f "$SSH_DIR/$key_file" ]; then
        if cp "$SSH_DIR/$key_file" "$BACKUP_DIR/${key_file}.${TIMESTAMP}" 2>> "$LOG_FILE"; then
            log "Backed up $key_file to $BACKUP_DIR/${key_file}.${TIMESTAMP}"
        else
            log_error "Failed to backup $key_file"
        fi
    fi
done

# Decrypt SSH keys
log "→ Decrypting SSH keys"
if decrypt_file "$VAULT/id_rsa.age" "$SSH_DIR/id_rsa"; then
    chmod 600 "$SSH_DIR/id_rsa"
fi

if decrypt_file "$VAULT/id_rsa.pub.age" "$SSH_DIR/id_rsa.pub"; then
    chmod 600 "$SSH_DIR/id_rsa.pub"
fi

if decrypt_file "$VAULT/id_ed25519.age" "$SSH_DIR/id_ed25519"; then
    chmod 600 "$SSH_DIR/id_ed25519"
fi

if decrypt_file "$VAULT/id_ed25519.pub.age" "$SSH_DIR/id_ed25519.pub"; then
    chmod 644 "$SSH_DIR/id_ed25519.pub"
fi

# Decrypt GPG keys to runtime directory
log "→ Decrypting GPG keys"
decrypt_file "$VAULT/inaudito-hi-pub.asc.age" "$SECRETS/inaudito-hi-pub.asc"
decrypt_file "$VAULT/inaudito-hi-priv.asc.age" "$SECRETS/inaudito-hi-priv.asc"
decrypt_file "$VAULT/inaudito-lo-pub.asc.age" "$SECRETS/inaudito-lo-pub.asc"
decrypt_file "$VAULT/inaudito-lo-priv.asc.age" "$SECRETS/inaudito-lo-priv.asc"

# Import GPG keys
log "→ Importing GPG keys"
for gpg_key in inaudito-hi-pub.asc inaudito-hi-priv.asc inaudito-lo-pub.asc inaudito-lo-priv.asc; do
    if [ -f "$SECRETS/$gpg_key" ]; then
        if gpg2 --import -q "$SECRETS/$gpg_key" >> "$LOG_FILE" 2>&1; then
            log_success "Imported $gpg_key"
        else
            log_error "Failed to import $gpg_key"
        fi
    else
        log_error "GPG key file not found: $gpg_key"
    fi
done

# Update git remote to use SSH
log "→ Updating dotfiles git remote to SSH"
if git --git-dir="$HOME/git/dotfiles" --work-tree="$HOME" remote set-url origin git@github.com:cheapmon/dotfiles.git >> "$LOG_FILE" 2>&1; then
    log_success "Updated dotfiles remote to SSH"
else
    log_error "Failed to update dotfiles remote"
fi

# Summary
log ""
log "→ Decryption complete"
log "Successful operations: $SUCCESS_COUNT"
log "Failed operations: $FAILURE_COUNT"

if [ "$FAILURE_COUNT" -gt 0 ]; then
    log "WARNING: Some operations failed. Check log for details."
    exit 1
fi

log "All secrets decrypted successfully"
exit 0
