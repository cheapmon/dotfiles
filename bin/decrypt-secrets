#!/usr/bin/env bash

set -e
set -o pipefail

umask 077

if [ -x "$HOME/bin/check-vault-key" ]; then
  "$HOME/bin/check-vault-key"
else
  echo "check-vault-key helper missing at $HOME/bin/check-vault-key" >&2
  exit 1
fi

VAULT="$HOME/.vault"
KEY="${XDG_CONFIG_HOME:-$HOME/.config}/age/key.txt"
SECRETS="/run/user/$(id -u)/secrets"

# Clean up any old decrypted files from .vault (migration from old approach)
if [ -d "$VAULT" ]; then
  find "$VAULT" -type f ! -name "*.age" -delete 2>/dev/null || true
fi

# Create secure runtime directory for decrypted secrets
mkdir -p "$SECRETS"
chmod 700 "$SECRETS"

# To encrypt a file: age -e -i "$KEY" "$VAULT/[filename]" > "$VAULT/[filename].age"
age -d -i "$KEY" "$VAULT/api_token.age" > "$SECRETS/api_token"
age -d -i "$KEY" "$VAULT/digitalocean_token.age" > "$SECRETS/digitalocean_token"
age -d -i "$KEY" "$VAULT/terraform_token.age" > "$SECRETS/terraform_token"
age -d -i "$KEY" "$VAULT/anthropic_api_key.age" > "$SECRETS/anthropic_api_key"

if [ ! -d "$HOME/.ssh" ]; then
  mkdir "$HOME/.ssh"
fi
chmod 700 "$HOME/.ssh"

age -d -i "$KEY" "$VAULT/id_rsa.age" > "$HOME/.ssh/id_rsa"
age -d -i "$KEY" "$VAULT/id_rsa.pub.age" > "$HOME/.ssh/id_rsa.pub"

chmod 600 "$HOME/.ssh/id_rsa"
chmod 600 "$HOME/.ssh/id_rsa.pub"

age -d -i "$KEY" "$VAULT/inaudito-hi-pub.asc.age" > "$SECRETS/inaudito-hi-pub.asc"
age -d -i "$KEY" "$VAULT/inaudito-hi-priv.asc.age" > "$SECRETS/inaudito-hi-priv.asc"
age -d -i "$KEY" "$VAULT/inaudito-lo-pub.asc.age" > "$SECRETS/inaudito-lo-pub.asc"
age -d -i "$KEY" "$VAULT/inaudito-lo-priv.asc.age" > "$SECRETS/inaudito-lo-priv.asc"

gpg2 --import -q "$SECRETS/inaudito-hi-pub.asc"
gpg2 --import -q "$SECRETS/inaudito-hi-priv.asc"
gpg2 --import -q "$SECRETS/inaudito-lo-pub.asc"
gpg2 --import -q "$SECRETS/inaudito-lo-priv.asc"

git --git-dir="$HOME/git/dotfiles" --work-tree="$HOME" remote set-url origin git@github.com:cheapmon/dotfiles.git
