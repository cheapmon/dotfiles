#!/usr/bin/env bash
set -euo pipefail

# app
# Open architecture app or tmuxifier session in tmux.
#
# Uses fzf to select from merged list of:
#   - Tmuxifier sessions (marked with [S] if standalone)
#   - Architecture app directories
#
# Then:
#   - Loads existing tmuxifier session if available, OR
#   - Creates new tmux session in the app directory (for non-session entries)
#
# Dependencies: fzf-tmux, tmux, tmuxifier, ripgrep (rg)
# Side effects: Creates or switches to tmux session

# Initialize tmuxifier if the environment wasnâ€™t prepared by the parent shell.
if [ -z "${TMUXIFIER_LAYOUT_PATH:-}" ]; then
  case ":$PATH:" in
    *":$HOME/.tmuxifier/bin:"*) ;;
    *) PATH="$PATH:$HOME/.tmuxifier/bin" ;;
  esac

  if command -v tmuxifier >/dev/null 2>&1; then
    TMUXIFIER_NO_COMPLETE="${TMUXIFIER_NO_COMPLETE:-1}"
    eval "$(tmuxifier init -)"
  fi
fi

# Check dependencies
for cmd in fzf-tmux tmux tmuxifier rg; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "Error: Required command '$cmd' not found" >&2
    exit 1
  fi
done

APPS_DIR="$HOME/git/architecture/apps"

if [ ! -d "$APPS_DIR" ]; then
  echo "Error: Architecture apps directory not found: $APPS_DIR" >&2
  exit 1
fi

# Check if apps directory is empty
if [ -z "$(ls -A "$APPS_DIR")" ]; then
  echo "Error: No projects found in $APPS_DIR" >&2
  exit 1
fi

# Build merged list of sessions and apps
# 1. Get all tmuxifier sessions
# 2. Get all app directories
# 3. Mark session-only entries (not in apps dir) with [S] prefix

sessions=$(tmuxifier list-sessions 2>/dev/null || echo "")
apps=$(ls -1 "$APPS_DIR")

# Build the merged list
merged_list=""

# Add session-only entries with [S] marker
if [ -n "$sessions" ]; then
  while IFS= read -r session; do
    # Check if this session corresponds to an app directory
    if ! echo "$apps" | grep -q "^$session$"; then
      merged_list+="[S] $session"$'\n'
    fi
  done <<< "$sessions"
fi

# Add all apps (they may or may not have tmuxifier sessions)
merged_list+="$apps"

# Use fzf to select (allow cancellation)
set +e
selection="$(echo "$merged_list" | fzf-tmux)"
status=$?
set -e

if [ $status -ne 0 ] || [ -z "$selection" ]; then
  echo "No project selected" >&2
  exit 1
fi

# Parse selection: strip [S] prefix if present
is_session_only=false
if [[ "$selection" =~ ^\[S\]\ (.+)$ ]]; then
  is_session_only=true
  app="${BASH_REMATCH[1]}"
else
  app="$selection"
fi

dir="$APPS_DIR/$app"
inside_tmux=false
if [ -n "${TMUX:-}" ] || [ -n "${TMUX_PANE:-}" ]; then
  inside_tmux=true
fi

# Check if tmuxifier session exists
if tmuxifier list-sessions | rg -q "^$app$"; then
  tmuxifier load-session "$app"
  if [ "$inside_tmux" = true ]; then
    tmux switch -t "$app"
  fi
  exit 0
fi

# For session-only entries without a matching session, something went wrong
if [ "$is_session_only" = true ]; then
  echo "Error: Session '$app' not found in tmuxifier" >&2
  exit 1
fi

# Fall back to creating basic tmux session in app directory
if [ "$inside_tmux" = true ]; then
  tmux new -ds "$app" -c "$dir" 2>/dev/null || true
  tmux switch -t "$app"
else
  tmux new -As "$app" -c "$dir"
fi
