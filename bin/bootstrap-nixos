#!/usr/bin/env bash
#
# bootstrap-nixos - Bootstrap new NixOS system from dotfiles
#
# Performs initial system setup:
#   1. Validates age key exists and has correct permissions
#   2. Clones dotfiles as bare repository
#   3. Checks out dotfiles to home directory
#   4. Rebuilds NixOS from flake configuration
#   5. Decrypts secrets
#
# Prerequisites:
#   - Age key must exist at ~/.config/age/key.txt with 600 permissions
#   - SSH access to github.com/cheapmon/dotfiles
#
# Dependencies: git, nix, nixos-rebuild, age, decrypt-secrets
# Side effects:
#   - Clones dotfiles repository
#   - Overwrites files in home directory
#   - Rebuilds entire NixOS system
#   - Decrypts and installs secrets

set -e
set -o pipefail

RED="\033[0;31m"
NC="\033[0m"

KEY="${XDG_CONFIG_HOME:-$HOME/.config}/age/key.txt"

if [ ! -f "$KEY" ]; then
  echo -e "${RED}Private key file not found!${NC}"
  echo "Expected location: $KEY"
  echo "Make sure to place your age key at $KEY before running bootstrap"
  exit 1
fi

PERMS=$(stat -c "%a" "$KEY")
OWNER=$(stat -c "%u" "$KEY")
CURRENT_UID=$(id -u)

if [ "$OWNER" -ne "$CURRENT_UID" ]; then
  echo -e "${RED}Private key must be owned by the current user!${NC}"
  echo "Current uid: $CURRENT_UID, owner uid: $OWNER"
  exit 1
fi

if [ "$PERMS" != "600" ]; then
  echo -e "${RED}Private key permissions must be 600!${NC}"
  echo "Current permissions: $PERMS"
  exit 1
fi

nix-shell -p "git" --command "git clone --bare https://github.com/cheapmon/dotfiles.git $HOME/git/dotfiles"
nix-shell -p "git" --command "git --git-dir=$HOME/git/dotfiles --work-tree=$HOME checkout -f"
sudo nix-shell -p "git" --command "nixos-rebuild switch --impure --flake .config/nixos#default"

export PATH="$PATH:$HOME/bin"
decrypt-secrets
